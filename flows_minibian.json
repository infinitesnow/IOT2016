[{"id":"64d60be8.55cbb4","type":"tab","label":"Main"},{"id":"c56d2324.d06bf8","type":"tab","label":"Flow 2"},{"id":"391a1e48.15a482","type":"subflow","name":"GetInputAsJSON","info":"","in":[{"x":204.5,"y":202.5,"wires":[{"id":"29695f97.700d9"}]}],"out":[{"x":850.5,"y":263,"wires":[{"id":"7183362c.6322d","port":0}]}]},{"id":"761d44c2.e9f20c","type":"subflow","name":"ThingSpeak","info":"","in":[{"x":710.5,"y":311,"wires":[{"id":"e1d863c2.7f6608"}]}],"out":[{"x":1282.5,"y":350,"wires":[{"id":"9b083471.0a517","port":0}]}]},{"id":"b437662c.b19848","type":"subflow","name":"Logger","info":"","in":[{"x":512.5,"y":325,"wires":[{"id":"eae0ce2e.dd52b8"}]}],"out":[]},{"id":"2f9564e0.c71d14","type":"pubnub-keys","z":"","pub_key":"pub-c-54637d1c-3e6b-495a-9843-dadf17f13d55","sub_key":"sub-c-68c675a8-4ac5-11e7-99ed-0619f8945a4f"},{"id":"4a8f6ac5.b3d834","type":"inject","z":"64d60be8.55cbb4","name":"trigger","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"x":298.5,"y":225,"wires":[["d1a3a2b9.abe558"]]},{"id":"29695f97.700d9","type":"exec","z":"391a1e48.15a482","command":"python3 -u collect.py","addpay":true,"append":"","useSpawn":true,"timer":"","name":"ReadSerialConsole","x":374.5,"y":202.5,"wires":[["7183362c.6322d"],[],[]]},{"id":"7183362c.6322d","type":"json","z":"391a1e48.15a482","name":"ParseJSONOutput","x":680.5,"y":263,"wires":[[]]},{"id":"9b083471.0a517","type":"http request","z":"761d44c2.e9f20c","name":"","method":"GET","ret":"txt","url":"","tls":"","x":1132.5,"y":350,"wires":[[]]},{"id":"3526333c.6c2aec","type":"debug","z":"64d60be8.55cbb4","name":"","active":true,"console":"false","complete":"true","x":862.5,"y":616,"wires":[]},{"id":"e1d863c2.7f6608","type":"function","z":"761d44c2.e9f20c","name":"GenereteRequestURL","func":"temperature = msg.payload.temperature\nhumidity = msg.payload.humidity\nurl = \"https://api.thingspeak.com/update?api_key=F1AGZDQ65MB8IU70&field1=\"+temperature+\"&field2=\"+humidity\nreturn {url: url}","outputs":1,"noerr":0,"x":890.5,"y":311,"wires":[["9b083471.0a517"]]},{"id":"e3f88f73.0aa48","type":"catch","z":"64d60be8.55cbb4","name":"","scope":null,"x":450.5,"y":510,"wires":[["3526333c.6c2aec","d1a3a2b9.abe558"]]},{"id":"d1a3a2b9.abe558","type":"subflow:391a1e48.15a482","z":"64d60be8.55cbb4","name":"","x":599.5,"y":300.75,"wires":[["d04430d7.5084d8","f6ed1b6f.4dc8a8","94cc6096.a5861"]]},{"id":"d04430d7.5084d8","type":"subflow:761d44c2.e9f20c","z":"64d60be8.55cbb4","name":"","x":884.5,"y":254.5,"wires":[[]]},{"id":"f6ed1b6f.4dc8a8","type":"pubnub out","z":"64d60be8.55cbb4","keys":"2f9564e0.c71d14","channel":"dallalongaIOT","auth_token":"","cipher_key":"","ssl":true,"verbose_logging":false,"x":822.5,"y":143,"wires":[]},{"id":"3d45ebbb.31e4ec","type":"file","z":"b437662c.b19848","name":"log","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"false","x":915.5,"y":333,"wires":[]},{"id":"eae0ce2e.dd52b8","type":"function","z":"b437662c.b19848","name":"FormatToCSV","func":"line = msg.payload.id+\",\"+msg.payload.temperature+\",\"+msg.payload.humidity\ntoday = new Date()\nsuffix = \"\"+today.getFullYear()+today.getMonth()+today.getDate()\nreturn {payload: line, filename: \"/home/infinitesnow/log/log-\"+suffix+\".csv\"};","outputs":1,"noerr":0,"x":672.5,"y":325,"wires":[["3d45ebbb.31e4ec"]]},{"id":"94cc6096.a5861","type":"subflow:b437662c.b19848","z":"64d60be8.55cbb4","name":"","x":1004,"y":419,"wires":[]},{"id":"b0ff4173.91ad98","type":"inject","z":"c56d2324.d06bf8","name":"Trigger","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 13 * * *","once":false,"x":107.5,"y":93,"wires":[["a8b1578e.9ba9d"]]},{"id":"a8b1578e.9ba9d","type":"function","z":"c56d2324.d06bf8","name":"YesterdaysLog","func":"today = new Date()\nsuffix = \"\"+today.getFullYear()+today.getMonth()+(today.getDate()-1)\nreturn {filename: \"/home/infinitesnow/log/log-\"+suffix+\".csv\"};","outputs":1,"noerr":0,"x":260.5,"y":220,"wires":[["e1fcdb2b.86176"]]},{"id":"fc6bae4d.0a195","type":"debug","z":"c56d2324.d06bf8","name":"","active":true,"console":"false","complete":"true","x":923.5,"y":657,"wires":[]},{"id":"e1fcdb2b.86176","type":"file in","z":"c56d2324.d06bf8","name":"","filename":"","format":"utf8","x":397.5,"y":317,"wires":[["1ca688ab.c4ce47"]]},{"id":"1ca688ab.c4ce47","type":"csv","z":"c56d2324.d06bf8","name":"","sep":",","hdrin":"","hdrout":"","multi":"mult","ret":"\\n","temp":"id,temperature,humidity","x":553.5,"y":444,"wires":[["d14c1f9b.66f9"]]},{"id":"d14c1f9b.66f9","type":"function","z":"c56d2324.d06bf8","name":"Average","func":"var tempsum=0\nvar humsum=0\nvar items=msg.payload\nvar count = items.length\n\nfor (var i=0; i<count; i++){\n    tempsum+=items[i].temperature\n    humsum+=items[i].humidity\n}\n\nvar tempavg=tempsum/count\nvar humavg=humsum/count\n\nreturn {temperature_avg: tempavg, humidity_avg: humavg};","outputs":1,"noerr":0,"x":724.5,"y":541,"wires":[["c30996cc.fe3378"]]},{"id":"a096e497.5c8fc8","type":"e-mail","z":"c56d2324.d06bf8","server":"smtp.gmail.com","port":"465","secure":true,"name":"leledallalonga@gmail.com","dname":"","x":1076.5,"y":304,"wires":[]},{"id":"c30996cc.fe3378","type":"function","z":"c56d2324.d06bf8","name":"","func":"var message = \"Yesterday the average temperature was \"+msg.temperature_avg.toFixed(2)+\"Â°, with an average humidity of \"+msg.humidity_avg.toFixed(2)+\"%.\\n\\nHave a nice day!\"\nreturn {payload: message, topic: \"Weather summary\" };","outputs":1,"noerr":0,"x":826.5,"y":423,"wires":[["a096e497.5c8fc8","fc6bae4d.0a195","be4ccce8.c60358"]]},{"id":"be4ccce8.c60358","type":"e-mail","z":"c56d2324.d06bf8","server":"smtp.gmail.com","port":"465","secure":true,"name":"angela.broggi22@gmail.com","dname":"","x":1021,"y":213,"wires":[]}]